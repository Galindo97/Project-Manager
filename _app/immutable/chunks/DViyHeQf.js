import{y as g}from"./Cxs6_Da5.js";const u="http://localhost:8000";function l(){return localStorage.getItem("access_token")}function h(e){localStorage.setItem("access_token",e)}function d(){localStorage.removeItem("access_token")}async function c(e,t={}){const n=l(),s={"Content-Type":"application/json"};t.headers&&Object.entries(t.headers).forEach(([a,i])=>{typeof i=="string"&&(s[a]=i)}),n&&(s.Authorization=`Bearer ${n}`);const r=await fetch(`${u}${e}`,{...t,headers:s});if(r.status===401)throw d(),window.location.href="/login",new Error("Unauthorized");if(!r.ok&&r.status!==204){const a=await r.json().catch(()=>({detail:"Request failed"}));throw new Error(a.detail||"Request failed")}return r.status===204?null:r.json()}const o={async register(e,t,n){return c("/register",{method:"POST",body:JSON.stringify({username:e,email:t,password:n})})},async login(e,t){const n=new URLSearchParams;n.append("username",e),n.append("password",t);const s=await fetch(`${u}/login`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:n});if(!s.ok){const a=await s.json().catch(()=>({detail:"Login failed"}));throw new Error(a.detail||"Login failed")}const r=await s.json();return h(r.access_token),r},async getCurrentUser(){return c("/users/me")},logout(){d(),window.location.href="/login"},isAuthenticated(){return!!l()}},y={async getAll(){return c("/tasks")},async getById(e){return c(`/tasks/${e}`)},async create(e){return c("/tasks",{method:"POST",body:JSON.stringify(e)})},async update(e,t){return c(`/tasks/${e}`,{method:"PUT",body:JSON.stringify(t)})},async delete(e){return c(`/tasks/${e}`,{method:"DELETE"})}};function f(){const{subscribe:e,set:t,update:n}=g({user:null,isAuthenticated:o.isAuthenticated(),isLoading:!1});return{subscribe:e,async login(s,r){n(a=>({...a,isLoading:!0}));try{await o.login(s,r);const a=await o.getCurrentUser();return t({user:a,isAuthenticated:!0,isLoading:!1}),!0}catch(a){throw t({user:null,isAuthenticated:!1,isLoading:!1}),a}},async register(s,r,a){n(i=>({...i,isLoading:!0}));try{await o.register(s,r,a),await o.login(s,a);const i=await o.getCurrentUser();return t({user:i,isAuthenticated:!0,isLoading:!1}),!0}catch(i){throw t({user:null,isAuthenticated:!1,isLoading:!1}),i}},async loadUser(){if(!o.isAuthenticated()){t({user:null,isAuthenticated:!1,isLoading:!1});return}n(s=>({...s,isLoading:!0}));try{const s=await o.getCurrentUser();t({user:s,isAuthenticated:!0,isLoading:!1})}catch{o.logout(),t({user:null,isAuthenticated:!1,isLoading:!1})}},logout(){o.logout(),t({user:null,isAuthenticated:!1,isLoading:!1})}}}const A=f();export{A as a,y as t};
